<!DOCTYPE html>
<html>
<head>
    <title>头像访问综合测试</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        img { max-width: 200px; margin: 10px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 8px 15px; }
        textarea { width: 100%; height: 100px; }
    </style>
</head>
<body>
    <h1>头像访问综合测试</h1>
    
    <div class="test-section">
        <h3>测试1: 静态资源直接访问</h3>
        <p>测试URL: <span id="staticUrl">http://localhost:8080/uploads/avatars/6c57130c-5d6c-4ce2-9d1b-ec453ae18d8a.jpg</span></p>
        <img id="staticImg" src="http://localhost:8080/uploads/avatars/6c57130c-5d6c-4ce2-9d1b-ec453ae18d8a.jpg" 
             onload="showResult('static-result', 'success', '静态资源访问成功')" 
             onerror="showResult('static-result', 'error', '静态资源访问失败')">
        <div id="static-result"></div>
        <button onclick="testStaticResource()">重新测试静态资源</button>
    </div>
    
    <div class="test-section">
        <h3>测试2: 通过API控制器访问</h3>
        <p>测试URL: <span id="apiUrl">http://localhost:8080/api/files/avatar/6c57130c-5d6c-4ce2-9d1b-ec453ae18d8a.jpg</span></p>
        <img id="apiImg" src="http://localhost:8080/api/files/avatar/6c57130c-5d6c-4ce2-9d1b-ec453ae18d8a.jpg" 
             onload="showResult('api-result', 'success', 'API控制器访问成功')" 
             onerror="showResult('api-result', 'error', 'API控制器访问失败')">
        <div id="api-result"></div>
        <button onclick="testApiResource()">重新测试API资源</button>
    </div>
    
    <div class="test-section">
        <h3>测试3: 文件列表查看</h3>
        <button onclick="listFiles()">查看所有头像文件</button>
        <div id="file-list"></div>
    </div>
    
    <div class="test-section">
        <h3>测试4: 网络请求详情</h3>
        <button onclick="checkNetworkDetails()">检查网络请求详情</button>
        <div id="network-details"></div>
    </div>
    
    <div class="test-section">
        <h3>测试5: 后端状态检查</h3>
        <button onclick="checkBackendStatus()">检查后端状态</button>
        <div id="backend-status"></div>
    </div>
    
    <div class="test-section">
        <h3>调试日志</h3>
        <textarea id="debug-log" readonly></textarea>
        <button onclick="clearLog()">清空日志</button>
    </div>
    
    <script>
        function log(message) {
            const logArea = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logArea.value += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }
        
        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = type;
            element.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            log(`${elementId}: ${message}`);
        }
        
        async function testStaticResource() {
            const url = 'http://localhost:8080/uploads/avatars/6c57130c-5d6c-4ce2-9d1b-ec453ae18d8a.jpg';
            log(`测试静态资源访问: ${url}`);
            
            try {
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                log(`静态资源响应: ${response.status} ${response.statusText}`);
                log(`Content-Type: ${response.headers.get('Content-Type')}`);
                log(`Content-Length: ${response.headers.get('Content-Length')}`);
                
                if (response.ok) {
                    showResult('static-result', 'success', `静态资源访问成功 (${response.status})`);
                    // 重新加载图片
                    document.getElementById('staticImg').src = url + '?t=' + Date.now();
                } else {
                    showResult('static-result', 'error', `静态资源访问失败: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                log(`静态资源访问异常: ${error.message}`);
                showResult('static-result', 'error', `访问异常: ${error.message}`);
            }
        }
        
        async function testApiResource() {
            const url = 'http://localhost:8080/api/files/avatar/6c57130c-5d6c-4ce2-9d1b-ec453ae18d8a.jpg';
            log(`测试API资源访问: ${url}`);
            
            try {
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                log(`API资源响应: ${response.status} ${response.statusText}`);
                log(`Content-Type: ${response.headers.get('Content-Type')}`);
                log(`Content-Length: ${response.headers.get('Content-Length')}`);
                
                if (response.ok) {
                    showResult('api-result', 'success', `API控制器访问成功 (${response.status})`);
                    // 重新加载图片
                    document.getElementById('apiImg').src = url + '?t=' + Date.now();
                } else {
                    showResult('api-result', 'error', `API控制器访问失败: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                log(`API资源访问异常: ${error.message}`);
                showResult('api-result', 'error', `访问异常: ${error.message}`);
            }
        }
        
        async function listFiles() {
            const url = 'http://localhost:8080/api/files/avatars';
            log(`获取文件列表: ${url}`);
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                log(`文件列表响应: ${response.status}`);
                log(`文件列表内容: ${text}`);
                
                document.getElementById('file-list').innerHTML = 
                    `<pre style="background: #f5f5f5; padding: 10px; border-radius: 3px;">${text}</pre>`;
            } catch (error) {
                log(`获取文件列表失败: ${error.message}`);
                document.getElementById('file-list').innerHTML = 
                    `<span class="error">获取文件列表失败: ${error.message}</span>`;
            }
        }
        
        async function checkNetworkDetails() {
            const urls = [
                'http://localhost:8080/uploads/avatars/6c57130c-5d6c-4ce2-9d1b-ec453ae18d8a.jpg',
                'http://localhost:8080/api/files/avatar/6c57130c-5d6c-4ce2-9d1b-ec453ae18d8a.jpg'
            ];
            
            let details = '<h4>网络请求详情:</h4>';
            
            for (const url of urls) {
                try {
                    log(`检查URL: ${url}`);
                    const response = await fetch(url, { method: 'HEAD' });
                    
                    details += `<div style="margin: 10px 0; padding: 10px; background: #f9f9f9;">`;
                    details += `<strong>${url}</strong><br>`;
                    details += `状态: ${response.status} ${response.statusText}<br>`;
                    details += `Content-Type: ${response.headers.get('Content-Type') || 'N/A'}<br>`;
                    details += `Content-Length: ${response.headers.get('Content-Length') || 'N/A'}<br>`;
                    details += `Cache-Control: ${response.headers.get('Cache-Control') || 'N/A'}<br>`;
                    details += `</div>`;
                    
                } catch (error) {
                    details += `<div style="margin: 10px 0; padding: 10px; background: #ffe6e6;">`;
                    details += `<strong>${url}</strong><br>`;
                    details += `<span class="error">错误: ${error.message}</span><br>`;
                    details += `</div>`;
                }
            }
            
            document.getElementById('network-details').innerHTML = details;
        }
        
        async function checkBackendStatus() {
            const testUrls = [
                'http://localhost:8080/api/auth/check-username?username=test',
                'http://localhost:8080/api/user/list-all',
                'http://localhost:8080/api/files/avatars'
            ];
            
            let status = '<h4>后端状态检查:</h4>';
            
            for (const url of testUrls) {
                try {
                    log(`检查后端接口: ${url}`);
                    const response = await fetch(url);
                    
                    status += `<div style="margin: 5px 0;">`;
                    status += `${url}: <span class="${response.ok ? 'success' : 'error'}">${response.status} ${response.statusText}</span>`;
                    status += `</div>`;
                    
                } catch (error) {
                    status += `<div style="margin: 5px 0;">`;
                    status += `${url}: <span class="error">连接失败 - ${error.message}</span>`;
                    status += `</div>`;
                }
            }
            
            document.getElementById('backend-status').innerHTML = status;
        }
        
        function clearLog() {
            document.getElementById('debug-log').value = '';
        }
        
        // 页面加载时自动执行一些测试
        window.onload = function() {
            log('页面加载完成，开始自动测试...');
            setTimeout(() => {
                checkBackendStatus();
                listFiles();
            }, 1000);
        };
    </script>
</body>
</html>