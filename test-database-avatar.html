<!DOCTYPE html>
<html>
<head>
    <title>数据库头像测试</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        img { max-width: 200px; margin: 10px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 8px 15px; }
        textarea { width: 100%; height: 100px; }
        .file-input { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>数据库头像存储测试</h1>
    
    <div class="test-section">
        <h3>步骤1: 登录获取Token</h3>
        <input type="text" id="username" placeholder="用户名" value="aaa">
        <input type="password" id="password" placeholder="密码" value="123456">
        <button onclick="login()">登录</button>
        <div id="login-result"></div>
    </div>
    
    <div class="test-section">
        <h3>步骤2: 上传头像到数据库</h3>
        <div class="file-input">
            <input type="file" id="avatar-file" accept="image/*">
            <button onclick="uploadAvatar()">上传头像</button>
        </div>
        <div id="upload-result"></div>
    </div>
    
    <div class="test-section">
        <h3>步骤3: 测试头像访问</h3>
        <p>当前用户ID: <span id="current-user-id">未登录</span></p>
        <button onclick="testAvatarAccess()">测试头像访问</button>
        <div id="avatar-test-result"></div>
        <div id="avatar-display"></div>
    </div>
    
    <div class="test-section">
        <h3>调试日志</h3>
        <textarea id="debug-log" readonly></textarea>
        <button onclick="clearLog()">清空日志</button>
    </div>
    
    <script>
        let authToken = '';
        let currentUserId = null;
        
        function log(message) {
            const logArea = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logArea.value += `[${timestamp}] ${message}\\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }\n        \n        function showResult(elementId, type, message) {\n            const element = document.getElementById(elementId);\n            element.className = type;\n            element.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;\n            log(`${elementId}: ${message}`);\n        }\n        \n        async function login() {\n            const username = document.getElementById('username').value;\n            const password = document.getElementById('password').value;\n            \n            try {\n                log(`尝试登录: ${username}`);\n                \n                const response = await fetch('http://localhost:8080/api/auth/login', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        username: username,\n                        password: password\n                    })\n                });\n                \n                const data = await response.json();\n                log(`登录响应: ${JSON.stringify(data)}`);\n                \n                if (data.code === 200) {\n                    authToken = data.data.token;\n                    currentUserId = data.data.userInfo.id;\n                    document.getElementById('current-user-id').textContent = currentUserId;\n                    \n                    showResult('login-result', 'success', `登录成功! 用户ID: ${currentUserId}`);\n                } else {\n                    showResult('login-result', 'error', `登录失败: ${data.message}`);\n                }\n            } catch (error) {\n                log(`登录异常: ${error.message}`);\n                showResult('login-result', 'error', `登录异常: ${error.message}`);\n            }\n        }\n        \n        async function uploadAvatar() {\n            const fileInput = document.getElementById('avatar-file');\n            const file = fileInput.files[0];\n            \n            if (!file) {\n                showResult('upload-result', 'error', '请选择文件');\n                return;\n            }\n            \n            if (!authToken) {\n                showResult('upload-result', 'error', '请先登录');\n                return;\n            }\n            \n            try {\n                log(`开始上传头像: ${file.name} (${file.size} bytes)`);\n                \n                const formData = new FormData();\n                formData.append('avatar', file);\n                \n                const response = await fetch('http://localhost:8080/api/user/upload-avatar', {\n                    method: 'POST',\n                    headers: {\n                        'Authorization': `Bearer ${authToken}`\n                    },\n                    body: formData\n                });\n                \n                const data = await response.json();\n                log(`上传响应: ${JSON.stringify(data)}`);\n                \n                if (data.code === 200) {\n                    showResult('upload-result', 'success', `头像上传成功! URL: ${data.data}`);\n                    // 自动测试访问\n                    setTimeout(() => testAvatarAccess(), 1000);\n                } else {\n                    showResult('upload-result', 'error', `上传失败: ${data.message}`);\n                }\n                \n            } catch (error) {\n                log(`上传异常: ${error.message}`);\n                showResult('upload-result', 'error', `上传异常: ${error.message}`);\n            }\n        }\n        \n        async function testAvatarAccess() {\n            if (!currentUserId) {\n                showResult('avatar-test-result', 'error', '请先登录');\n                return;\n            }\n            \n            const avatarUrl = `http://localhost:8080/api/user/avatar/${currentUserId}`;\n            log(`测试头像访问: ${avatarUrl}`);\n            \n            try {\n                const response = await fetch(avatarUrl);\n                log(`头像访问响应: ${response.status} ${response.statusText}`);\n                log(`Content-Type: ${response.headers.get('Content-Type')}`);\n                log(`Content-Length: ${response.headers.get('Content-Length')}`);\n                \n                if (response.ok) {\n                    showResult('avatar-test-result', 'success', `头像访问成功 (${response.status})`);\n                    \n                    // 显示头像\n                    const avatarDisplay = document.getElementById('avatar-display');\n                    avatarDisplay.innerHTML = `\n                        <h4>头像显示:</h4>\n                        <img src=\"${avatarUrl}?t=${Date.now()}\" \n                             onload=\"log('头像图片加载成功')\" \n                             onerror=\"log('头像图片加载失败')\">\n                        <p>URL: <a href=\"${avatarUrl}\" target=\"_blank\">${avatarUrl}</a></p>\n                    `;\n                } else {\n                    showResult('avatar-test-result', 'error', `头像访问失败: ${response.status} ${response.statusText}`);\n                }\n            } catch (error) {\n                log(`头像访问异常: ${error.message}`);\n                showResult('avatar-test-result', 'error', `访问异常: ${error.message}`);\n            }\n        }\n        \n        function clearLog() {\n            document.getElementById('debug-log').value = '';\n        }\n        \n        // 页面加载时的提示\n        window.onload = function() {\n            log('页面加载完成');\n            log('测试流程: 1.登录 -> 2.上传头像 -> 3.测试访问');\n        };\n    </script>\n</body>\n</html>